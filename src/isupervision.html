<!DOCTYPE html>
<html lang="en">
<head>
    <title>Viewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <link href="css/styles.css" rel="stylesheet"/>  
    <link href="css/annotation-style.css" rel="stylesheet"/>

    <style>
        body {
            background-color: white;
            padding: 0;
            margin: 0;
        }
    </style>

<body>

<div id="info">
</div>

<div id="dat-gui-container">
</div>

    <script src="js/xeogl/xeogl.js"></script>
    <script src="js/xeogl/models/glTFModel.js"></script>

    <script src="js/xeogl/skyboxes/skybox.js"></script>
    <script src="js/xeogl/libs/dat.gui.min.js"></script>

    <script src="js/xeogl/annotations/pin.js"></script>
    <script src="js/xeogl/annotations/annotation.js"></script>

    <script src="js/energieip/energieip.js"></script>
    <script src="js/energieip/drivers/driver.js"></script>
    <script src="js/energieip/drivers/sensor.js"></script>
    <script src="js/energieip/drivers/led.js"></script>

<script>
    var scene = new xeogl.Scene({
        transparent: true
    });
    xeogl.setDefaultScene(scene);
    var camera = scene.camera;
    var input = scene.input;

    var gui = null;
    
    var drivers = {};

    var buf = [];

    //Right Menu
    var Menu = function (driver) {
        this["driver"] = driver.deviceType;
        this["Group"] = driver.group;
        this["cf.Name"] = driver.friendlyName;
        this["st.Name"] = driver.friendlyName;
        this["gr.Auto"] = driver.auto;
        this["gr.Setpoint"] = driver.setpoint;
        switch (driver.deviceType){
            case energieip.ledDriver:
                this["st.Auto"] = driver.auto;
                
                this["dr.Auto"] = driver.auto;
                this["st.Setpoint"] = driver.setpoint;
                
                this["dr.Setpoint"] = driver.setpoint;
                break;
        }

        var self = this;
        var update = function () {
            //driver.group = self["Group"];
           // driver.friendlyName = self["Name"];
           // if (driver.deviceType == "Led") {
           //     driver.auto = self["Auto"];
           //     driver.setpoint = self["Setpoint"];
           // }
            requestAnimationFrame(update);
        };
        update();
    };

    var menu = null;

    function flyTo() {
        var driver;
        var selected;

        for (var label in drivers) {
            driver = drivers[label];
            selected = driver.id === this.id;
            if (selected) {
                if (gui != null){
                    document.getElementById('dat-gui-container').removeChild(gui.domElement);
                    gui.destroy();  
                }
                gui = new dat.GUI({autoPlace: false, top: 0, width: 400});
                document.getElementById('dat-gui-container').appendChild(gui.domElement);
 
                menu = new Menu(driver);

                var status = gui.addFolder("Driver Status");
                status.add(menu, "driver", driver.deviceType).name("Driver").listen();
                status.add(menu, "Group", driver.group).listen();
                status.add(menu, "st.Name", driver.friendlyName).name("Name").listen();

                switch (driver.deviceType){
                    case energieip.ledDriver:
                        status.add(menu, "st.Auto", driver.auto).name("Auto").listen();
                        status.add(menu, "st.Setpoint", driver.setpoint).name("Setpoint").listen();
                        break;
                    case energieip.sensorDriver:
                        break;
                }
                status.open();

                switch (driver.deviceType){
                    case energieip.ledDriver:
                        var controlDr = gui.addFolder("Driver Control");
                        controlDr.add(menu, "dr.Setpoint", driver.setpoint).name("Setpoint");
                        controlDr.add({"OK":function(){ console.log("clicked", driver ) }}, "OK").name("Apply");
                        break;
                }

                var controlGr = gui.addFolder("Group Control");
                controlGr.add(menu, "gr.Setpoint", driver.group).name("Setpoint");
                controlGr.add({"OK":function(){ console.log("clicked", driver ) }}, "OK").name("Apply");

                var configuration = gui.addFolder("Driver Configuration");
                configuration.add(menu, "cf.Name", driver.group).name("Name");
                configuration.add({"OK":function(){ console.log("clicked", driver ) }}, "OK").name("Apply");

            }
            driver.labelShown = selected;
        }
    }


    //---------------------------------------------------
    // Load the model
    //---------------------------------------------------
    var model = new xeogl.GLTFModel({
        id: "map",
        src: "maps/N8B-3MK-V4.optimized.gltf",
        scale: [.6, .6, .6],
        objectTree: true,
        handleNode: (function() {
            return function (nodeInfo, actions) {
                console.log("=== " , nodeInfo);
                if (nodeInfo.name && nodeInfo.mesh !== undefined) {
                    var parse = nodeInfo.name.split("_");
                    parse.splice(0, 1);
                    var label = parse.join("_");
                    if (label.indexOf('_') > -1){
                        actions.createObject = {
                            id: label,
                        };
                    }
                }
                return true;
            };
        })()
    });
    model.ghosted = false;


    //-----------------------------------------------------------------------------------------------------
    // Camera
    //-----------------------------------------------------------------------------------------------------

    camera.eye = [-20.21798706054688, 50.6997528076172, -40.179931640625];
    camera.up = [0,1,0];

    model.on("loaded", function () {
        scene.on("tick", function () { // Slowly orbit the camera

        });
        var ifcDrivers = energieip.GetIfcDump(true, true, false);
        for (var label in model.meshes){
            if (ifcDrivers.hasOwnProperty(label)){
                var mesh = model.meshes[label];
                var ifcModel = ifcDrivers[label];
                console.log("get ifcModel", ifcModel);
                var driver = null;
                var content = {
                    label: label,
                    mesh: mesh,
                    occludable: false,
                    glyph: ifcModel["status"].group.toString(),
                    title: "",
                    desc: "",
                    mac: ifcModel["ifc"].mac,
                    friendlyName: "",
                    group: ifcModel["status"].group,
                    pinShown: true,
                    labelShown: false
                }
                switch (ifcModel["ifc"].deviceType) {
                    case energieip.sensorDriver:
                        content["temperature"] = ifcModel["status"].temperature;
                        var driver = new energieip.SensorSupervision(content);
                        break;
                    case energieip.ledDriver:
                        content["auto"] = ifcModel["status"].auto;
                        content["setpoint"] = ifcModel["status"].setpoint;
                        var driver = new energieip.LedSupervision(content);
                        driver.on("auto", energieip.SendLedCmd);
                        driver.on("setpoint", energieip.SendLedCmd);
                        break;
                    default:
                        console.log("Received type", ifcModel["ifc"].deviceType);
                        break;
                }
                if (driver != null){
                    driver.on("pinClicked", flyTo);
                    drivers[label] = driver;
                }
            }
        }
        energieip.Notifications();
    });

    //----------------------------
    // Controls
    //----------------------------
  var cameraControl = new xeogl.CameraControl({
//        panToPointer: true,
//        pivoting: true
    });

    var cameraFlight = new xeogl.CameraFlightAnimation();

    cameraControl.on("hoverEnter", function (hit) {
        if (drivers.hasOwnProperty(hit.mesh.id)){
            drivers[hit.mesh.id].labelShown = true;
        }
        hit.mesh.highlighted = true;
    });

    cameraControl.on("hoverOut", function (hit) {
        if (drivers.hasOwnProperty(hit.mesh.id)){
            drivers[hit.mesh.id].labelShown = false;
        }
        hit.mesh.highlighted = false;
    });

    cameraControl.on("picked", function (hit) {
        var mesh = hit.mesh;
        if (input.keyDown[input.KEY_SHIFT]) {
            mesh.selected = !mesh.selected;
            mesh.highlighted = !mesh.selected;
        } else {
            cameraFlight.flyTo(mesh);
        }
    });

    cameraControl.on("pickedNothing", function (hit) {
        cameraFlight.flyTo(model);
    });

</script>
</body>
</html>